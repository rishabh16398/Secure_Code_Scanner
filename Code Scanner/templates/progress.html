{% extends "base.html" %} 

{% block content %}

<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <div class="card glass-card shadow-lg border-0">
      <div class="card-body p-4">
        <h1 class="h4 mb-4 text-accent">üîç Scanning Projects</h1>

        <!-- Progress Bar -->
        <div class="mb-4">
          <div class="d-flex justify-content-between mb-2">
            <span class="small text-muted">Progress</span>
            <span class="small text-accent" id="progress-text">0/0 files</span>
          </div>
          <div class="progress" style="height: 25px; background-color: rgba(255,255,255,0.1);">
            <div 
              id="progress-bar" 
              class="progress-bar progress-bar-striped progress-bar-animated" 
              role="progressbar" 
              style="width: 0%; background: linear-gradient(90deg, #6366f1, #e879f9);"
              aria-valuenow="0" 
              aria-valuemin="0" 
              aria-valuemax="100"
            >
              <span id="progress-percentage">0%</span>
            </div>
          </div>
        </div>

        <!-- Current File Info -->
        <div class="alert alert-info mb-4" id="current-file-box" style="display: none;">
          <div class="d-flex align-items-center gap-2">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <div>
              <strong>Currently scanning:</strong>
              <div id="current-filename" class="text-monospace small">-</div>
              <div id="current-stage" class="small text-muted">-</div>
            </div>
          </div>
        </div>

        <!-- Status Messages Log -->
        <div class="card bg-dark border-secondary mb-3" style="max-height: 400px; overflow-y: auto;">
          <div class="card-body p-3">
            <h6 class="text-muted mb-3">üìã Scan Log</h6>
            <div id="status-log" class="small font-monospace">
              <div class="text-muted">Connecting to scanner...</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2">
          <button 
            id="view-results-btn" 
            class="btn btn-accent w-100" 
            style="display: none;"
            onclick="window.location.href='{{ url_for('results_page') }}'"
          >
            ‚úÖ View Results
          </button>
          <button 
            id="back-btn" 
            class="btn btn-outline-light w-100" 
            style="display: none;"
            onclick="window.location.href='{{ url_for('index') }}'"
          >
            ‚¨ÖÔ∏è Back to Upload
          </button>
        </div>

        <!-- Cancel/Back (while scanning) -->
        <div id="scanning-controls" class="mt-3">
          <p class="text-muted small text-center">
            ‚ö†Ô∏è Do not close this page while scanning is in progress
          </p>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const scanId = "{{ scan_id }}";
  const progressBar = document.getElementById("progress-bar");
  const progressText = document.getElementById("progress-text");
  const progressPercentage = document.getElementById("progress-percentage");
  const currentFileBox = document.getElementById("current-file-box");
  const currentFilename = document.getElementById("current-filename");
  const currentStage = document.getElementById("current-stage");
  const statusLog = document.getElementById("status-log");
  const viewResultsBtn = document.getElementById("view-results-btn");
  const backBtn = document.getElementById("back-btn");
  const scanningControls = document.getElementById("scanning-controls");

  let currentProgress = 0;
  let totalFiles = 0;

  // Connect to Server-Sent Events
  const eventSource = new EventSource(`/progress_stream/${scanId}`);

  eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    switch(data.type) {
      case "progress":
        // Update progress bar
        currentProgress = data.current;
        totalFiles = data.total;
        const percentage = Math.round((currentProgress / totalFiles) * 100);
        
        progressBar.style.width = percentage + "%";
        progressBar.setAttribute("aria-valuenow", percentage);
        progressPercentage.textContent = percentage + "%";
        progressText.textContent = `${currentProgress}/${totalFiles} files`;
        
        // Update current file info
        currentFileBox.style.display = "block";
        currentFilename.textContent = data.filename;
        
        if (data.stage === "extracting") {
          currentStage.textContent = "‚öôÔ∏è Extracting ZIP file...";
        } else if (data.stage === "scanning") {
          currentStage.textContent = "üîç Running security scanners...";
        }
        break;
      
      case "status":
        // Add status message to log
        const statusDiv = document.createElement("div");
        statusDiv.className = "mb-1 text-light";
        statusDiv.textContent = data.message;
        statusLog.appendChild(statusDiv);
        statusLog.scrollTop = statusLog.scrollHeight;
        break;
      
      case "info":
        // Info message
        const infoDiv = document.createElement("div");
        infoDiv.className = "mb-1 text-info";
        infoDiv.textContent = "‚ÑπÔ∏è " + data.message;
        statusLog.appendChild(infoDiv);
        statusLog.scrollTop = statusLog.scrollHeight;
        break;
      
      case "error":
        // Error message
        const errorDiv = document.createElement("div");
        errorDiv.className = "mb-1 text-danger";
        errorDiv.textContent = "‚ùå " + data.message;
        statusLog.appendChild(errorDiv);
        statusLog.scrollTop = statusLog.scrollHeight;
        break;
      
      case "complete":
        // Scanning complete
        progressBar.style.width = "100%";
        progressBar.setAttribute("aria-valuenow", 100);
        progressPercentage.textContent = "100%";
        progressBar.classList.remove("progress-bar-animated");
        
        currentFileBox.style.display = "none";
        
        const completeDiv = document.createElement("div");
        completeDiv.className = "mb-1 text-success fw-bold";
        completeDiv.textContent = "üéâ " + data.message;
        statusLog.appendChild(completeDiv);
        statusLog.scrollTop = statusLog.scrollHeight;
        
        // Show buttons
        viewResultsBtn.style.display = "block";
        backBtn.style.display = "block";
        scanningControls.style.display = "none";
        
        // Close event source
        eventSource.close();
        break;
      
      case "keepalive":
        // Just a keepalive ping, do nothing
        break;
    }
  };

  eventSource.onerror = function(event) {
    console.error("EventSource error:", event);
    const errorDiv = document.createElement("div");
    errorDiv.className = "mb-1 text-danger";
    errorDiv.textContent = "‚ùå Connection error. Please refresh the page.";
    statusLog.appendChild(errorDiv);
    eventSource.close();
  };
</script>

{% endblock %}
